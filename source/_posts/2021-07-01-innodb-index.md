---
title: MySQL InnoDB B+树索引
categories: MySQL
tags: [MySQL, InnoDB, B+树]
date: 2021-07-01
---

阅读笔记

《MySQL是怎样运行的:从根儿上理解MySQL》

# InnoDB

## B+树索引

- 叶子节点上保存了"用户记录"
  - 主键索引，主键 + 所有用户记录的列值
  - 普通唯一二级索引，索引值 + 记录主键值（用于回表）
  - 普通非唯一二级索引，索引值 + 记录主键值（用于回表）
- 中间节点上每条记录上保存了索引值和对应下一层页的页号
  - 主键索引，主键 + 下一层页的页号
  - 普通唯一二级索引，索引值 + 主键值 + 下一层页的页号
  - 普通非唯一二级索引，索引值 + 主键值 + 下一层页的页号
- 树成长
  - 初始只有一个根节点，也当叶子节点用保存用户记录
  - 记录满超出一页后，根节点（中间节点）出现目录项记录。原先根节点上的用户记录拷贝到新的页中，插入新记录做页分裂。

## 聚簇索引
聚簇索引的特点
- 按照主键进行记录和页的排序
  例如innodb的主键索引
  - 节点中的记录是按主键排序的单项列表
  - 同一层节点是按主键排序的双向列表
- 叶子节点保存了完整的用户记录
  innodb的主键索引是聚簇索引，但是二级索引就不是聚簇索引了

## 对于B+树联合索引

索引的作用或者如下一些场景中可能利用索引提升效率

- 全值匹配
- 左边列匹配
- 列前缀匹配
    例如要对url地址做一级域名匹配，可以在url列上建立索引，将url字符串翻转后存储，内容如

    | url |
    | :- |
    | moc.udiab.www |
    | moc.elgoog.www |
    | ... |
    | gro.otw.www |

- 范围值匹配

    要范围查询的列可以建立该列开头的联合索引

- 精确匹配某一列，并范围查询另外一列

    可以建立精确匹配列开头+范围查询列作第二列的联合索引

- 用于排序

    - 非ASC、DESC混用的排序，按照排序顺序建立联合索引
    - 如果where字句中用了非排序的列，那只能先按照where字句过滤出结果，再对结果进行排序，也无法利用索引进行排序。
    - 用于排序的多个列不在同一个联合索引中，也不能使用联合索引排序
    - 排序使用索引不能在排序字句中包含表达式
      
      例如select * from person_info order by upper(name);
    
- 用于分组

    分组顺序和联合索引顺序相同时即可利用索引完成分组

- 回表
  - 代价

    需要回表的记录越多，使用二级索引的性能越差，可能差于全表扫描
  
  - 覆盖索引

    查询使用二级索引（例如联合索引）时，查询列表中的列都在（联合）索引的列中

## 挑选索引

- 搜索、排序或分组的列
- 列基数大的列

    列基数是指某一列值不相同的记录数

- 索引列的类型尽量小
- 冗余和重复的索引

    例如联合索引index_A_B和索引A就是重复的索引

- 参见上节何时走索引




