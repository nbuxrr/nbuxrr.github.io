---
title: MySQL成本计算
categories: MySQL
tags: [MySQL, cost]
date: 2023-01-09
---

## 基于成本的优化

### 成本概念

MySQL简单规定，IO成本取决于要读取的页面数，CPU成本取决于要访问的记录数

```
IO成本 = fcost_io(需要读取的页的个数)
CPU成本 = fcost_cpu(需要访问的行数)
```

### 单表访问的成本计算

1. 根据搜索条件，找出可用的索引

2. 计算基于全表扫描的代价

	- 聚簇索引的页面数 ```show table like "%table_name%";```
	- 表中的记录数 ```show table like "%table_name%";```

3. 计算使用不同索引的代价

	- 扫描的区间个数（不管页数）
	- 需要回表的记录数
		- 需要估算扫描区间索引左右两个点之间的记录数（距离）
		- 两个点之间的页面数：小于10个页，则可直接精确统计（遍历之间的页，每个页上的PAGE_N_RECS值累加即可；
		- 大于10个页，则左边界点向右读10个页面，计算10个页面的平均记录数，乘以左右边界之间的总页数，即得估算的区间记录数。
		- 区间总页数可访问左右边界的父节点，计算父节点左右边界之间的记录数（即下层的页数）（若父节点左右边界再不同也上，则如上步骤递归重复）

4. 基于统计数据的成本计算

	例如 IN (....)条件，
	- 若IN的数据个数比较小，例如不大于200，则使用索引单点扫描
	- 若N的数据个数比较多，例如大于200，则估算需要访问的记录数
		- 估算方法 表中的记录数 / 该索引的不重复记录数 = 每个索引值的平均重复记录数 =》 IN的数据个数 * 平均重复记录数 即得 可能需要访问的记录数 =》 IN的代价（缺点不精确）

### 连接查询的成本

连接成本 = 1次访问驱动表 + n次访问被驱动表，n为驱动表扇出的记录数

单表访问成本同上，另外

- 连接顺序会影响到成本值， 所以一般使用小表做驱动表，减少扇出的记录数，降低被驱动表的的访问成本；
- 多表JOIN时，理论上应该计算所有JOIN顺序的排列组合的情况都计算成本值，实际上，JOIN表个数比较多时，排列组合太多了，所以有个最小（最大）连接查询成本参数，当成本计算值超过这个值时，就不再继续往下计算；

